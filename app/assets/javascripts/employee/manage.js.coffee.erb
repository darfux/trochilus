# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/

<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>

initTableFilters = ->
	$('.filter').children('select').each ->
		$(this).change ->
			f = $.query.get('filters')
			f ||= {}
			filter = $(this).attr('id')
			if $(this).val()
				f[filter] = $(this).val()
			else
				delete f[filter]
			params = $.query.set('filters', f)
			if params.toString()
				location.search = params
			else
				location.href = location.pathname

	for elm in ['from', 'to']
		((type)->
			$("#fund_time_#{type}").change ->
				f = $.query.get('filters')
				f ||= {}
				time_key = 'time'
				f[time_key] ||= {}
				if $(this).val()
					f[time_key][type] = $(this).val()
				else
					delete f[time_key][type]
					if f[time_key] == {}
						delete f[time_key]
				location.search = $.query.set('filters', f))(elm)

		((type)->
			$("#project_time_#{type}").change ->
				f = $.query.get('filters')
				f ||= {}
				time_key = 'create_date'
				f[time_key] ||= {}
				if $(this).val()
					f[time_key][type] = $(this).val()
				else
					delete f[time_key][type]
					if f[time_key] == {}
						delete f[time_key]
				location.search = $.query.set('filters', f))(elm)
			

init_region_select = ->
	path = {
		state: "<%= region_state_path %>",
		city: "<%= region_city_path %>"
	}
	for pair in [['country', 'state'], ['state', 'city']]
		h = pair[0]
		l = pair[1]
		((h,l)->
			$("#region_#{h}_select").change ->
				val = $("#region_#{h}_select").val()
				$.ajax({
					url: path[l],
					type: 'GET',
					async: true,
					data: {p_id: val},
					datatype: 'json',
					success: (res)->
						selector = $("#region_#{l}_select")
						blank = selector.children()[0]
						selector.children().remove()
						selector.append(blank)
						for obj in res
							opt = $('<option/>')
							opt.val(obj.id)
							opt.html(obj.name)
							selector.append(opt)
						selector.change()
				})
		)(h,l)

ready = ->
	# puts $('#employee-nav-bar-function-area').html()
	bar = $('#employee-nav-bar-function-area')
	bardiv = $('#employee-nav-bar-function-area div')
	bar.css("margin-left", -bar.outerWidth()/2)
	initTableFilters()
	init_region_select()

$(document).ready(ready)
$(document).on('page:load', ready)
# puts $('#employee-nav-bar-function-area')

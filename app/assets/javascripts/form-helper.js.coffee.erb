<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>
root = exports ? this

getFormHref = ->
	href = window.location.href
	if href.match(/.*s$/)
		href += '/new'
	if href.match(/.*s\/\d+$/)
		href += '/edit'
	href

dosome = ->
	form = $('.common-form')
	return if form.length == 0
	form_wrap = $(form[0])
	form = form_wrap.children('form').first()
	return if $('div.field').children('a').length == 0
	refresh = $("<a href=''>刷新</a>")
	wait = $("<div style='color: gray'>请等待...</div>")
	refresh.click ->
		$(this).hide()
		wait.show()
		form = form_wrap.children('form').first()
		formdata = form.serialize()
		that = $(this)
		$.ajax({
			url: getFormHref(),
			type: 'GET',
			async: true,
			success: (res)-> 
				that.show()
				wait.hide()
				new_form = $(res).find('form').first()
				form = form_wrap.children('form').first()
				static_field = form.children('.static-form-field')
				new_form.children('.static-form-field').replaceWith(static_field)
				form.replaceWith(new_form)
				new_form.deserialize(formdata)
		})

		false
	form_wrap.prepend(refresh)
	form_wrap.prepend(wait)
	wait.hide()
	# $("div.field").each ->
	# 	if $(this).children("a[target='_blank']").size() > 0
	# 		console.log $(this).children('select')

init_region_select = ->
	path = {
		state: "<%= region_state_path %>",
		city: "<%= region_city_path %>"
	}
	for pair in [['country', 'state'], ['state', 'city']]
		h = pair[0]
		l = pair[1]
		((h,l)->
			$("#region_#{h}_select").change ->
				val = $("#region_#{h}_select").val()
				$.ajax({
					url: path[l],
					type: 'GET',
					async: true,
					data: {p_id: val},
					datatype: 'json',
					success: (res)->
						selector = $("#region_#{l}_select")
						blank = selector.children()[0]
						selector.children().remove()
						selector.append(blank)
						for obj in res
							opt = $('<option/>')
							opt.val(obj.id)
							opt.html(obj.name)
							selector.append(opt)
						selector.change()
				})
		)(h,l)

ready = ->
	# puts $('#employee-nav-bar-function-area').html()
	dosome()
	init_region_select()

$(document).ready(ready)
$(document).on('page:load', ready)